<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - StudyHub</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/chat.css">
    <link rel="stylesheet" href="/stylesheets/dark-mode.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">
                    <i class="fas fa-graduation-cap"></i>
                    <span>StudyHub</span>
                </a>
            </div>
            
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/courses" class="nav-link">Courses</a>
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/chat" class="nav-link active">Chat</a>
                <% if (user && user.role === 'admin') { %>
                    <a href="/admin" class="nav-link">Admin</a>
                <% } %>
            </div>

            <div class="nav-user">
                <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <% if (user) { %>
                    <div class="user-menu">
                        <div class="user-avatar">
                            <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="<%= user.name %>">
                        </div>
                        <div class="user-dropdown">
                            <a href="/dashboard/profile">Profile</a>
                            <a href="/auth/logout">Logout</a>
                        </div>
                    </div>
                <% } else { %>
                    <a href="/auth/login" class="btn btn-primary">Login</a>
                <% } %>
            </div>

            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="chat-container">
        <div class="chat-sidebar">
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> Messages</h2>
                <button class="btn btn-primary" id="newChatBtn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>

            <div class="chat-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="chatSearch" placeholder="Search chats...">
                </div>
            </div>

            <div class="chat-list" id="chatList">
                <% if (chats && chats.length > 0) { %>
                    <% chats.forEach(chat => { %>
                        <div class="chat-item <%= chat.unreadCount > 0 ? 'unread' : '' %>" 
                             data-chat-id="<%= chat._id %>">
                            <div class="chat-avatar">
                                <% if (chat.isGroup) { %>
                                    <div class="group-avatar">
                                        <i class="fas fa-users"></i>
                                    </div>
                                <% } else { %>
                                    <img src="<%= chat.otherParticipants[0]?.avatar || '/images/default-avatar.png' %>" 
                                         alt="<%= chat.otherParticipants[0]?.name %>">
                                <% } %>
                            </div>
                            
                            <div class="chat-info">
                                <div class="chat-name">
                                    <%= chat.chatName %>
                                    <% if (chat.unreadCount > 0) { %>
                                        <span class="unread-badge"><%= chat.unreadCount %></span>
                                    <% } %>
                                </div>
                                <div class="chat-preview">
                                    <% if (chat.lastMessage) { %>
                                        <span class="last-message">
                                            <%= chat.lastMessage.sender._id.toString() === user._id.toString() ? 'You: ' : '' %>
                                            <%= chat.lastMessage.content.length > 30 ? 
                                                chat.lastMessage.content.substring(0, 30) + '...' : 
                                                chat.lastMessage.content %>
                                        </span>
                                    <% } else { %>
                                        <span class="no-messages">No messages yet</span>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="chat-time">
                                <% if (chat.lastMessage) { %>
                                    <%= new Date(chat.lastMessage.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                <% } %>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-chats">
                        <i class="fas fa-comments"></i>
                        <h3>No chats yet</h3>
                        <p>Start a conversation with other students!</p>
                        <button class="btn btn-primary" id="startChatBtn">
                            <i class="fas fa-plus"></i> Start Chat
                        </button>
                    </div>
                <% } %>
            </div>
        </div>

        <div class="chat-main">
            <div class="welcome-screen">
                <div class="welcome-content">
                    <i class="fas fa-comments"></i>
                    <h2>Welcome to StudyHub Chat</h2>
                    <p>Connect with other students, share knowledge, and collaborate on your learning journey.</p>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" id="startIndividualChat">
                            <i class="fas fa-user"></i> Start Individual Chat
                        </button>
                        <button class="btn btn-secondary" id="startGroupChat">
                            <i class="fas fa-users"></i> Create Group Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Chat Modal -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="modal-close" id="closeNewChatModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="chat-type-selector">
                    <button class="chat-type-btn active" data-type="individual">
                        <i class="fas fa-user"></i> Individual Chat
                    </button>
                    <button class="chat-type-btn" data-type="group">
                        <i class="fas fa-users"></i> Group Chat
                    </button>
                </div>

                <div class="chat-form" id="individualChatForm">
                    <div class="form-group">
                        <label>Select User</label>
                        <select id="selectedUser" class="form-control">
                            <option value="">Choose a user...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="createIndividualChat">
                        <i class="fas fa-plus"></i> Start Chat
                    </button>
                </div>

                <div class="chat-form hidden" id="groupChatForm">
                    <div class="form-group">
                        <label>Group Name</label>
                        <input type="text" id="groupName" class="form-control" placeholder="Enter group name">
                    </div>
                    <div class="form-group">
                        <label>Select Members</label>
                        <div class="member-selector" id="memberSelector">
                            <!-- Members will be populated here -->
                        </div>
                    </div>
                    <button class="btn btn-primary" id="createGroupChat">
                        <i class="fas fa-plus"></i> Create Group
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    <% if (success && success.length > 0) { %>
        <div class="alert alert-success">
            <%= success %>
        </div>
    <% } %>
    
    <% if (error && error.length > 0) { %>
        <div class="alert alert-error">
            <%= error %>
        </div>
    <% } %>

    <script src="/javascripts/main.js"></script>
    <script src="/javascripts/chat.js"></script>
    <script src="/javascripts/dark-mode.js"></script>
</body>
</html> 